steps:
    - id: 'build  '
      name: 'gcr.io/cloud-builders/docker'
      args: ['build', '-t', 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}', '.']

    - id: 'push   '
      name: 'gcr.io/cloud-builders/docker'
      args: ['push', 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}']
      
    - id: 'migrate'
      name: 'gcr.io/google-appengine/exec-wrapper'
      args: ['-i', 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}',
             '-s', '${PROJECT_ID}:${_REGION}:${_SQL_INSTANCE_NAME}',
             '-e', 'PROJECT_ID=${PROJECT_ID}',
             '--', 'sh', 'django_migrate.sh']

    - id: 'deploy '
      name: 'gcr.io/cloud-builders/gcloud'
      args: ["run", "deploy", "${_SERVICE_NAME}", 
            "--platform", "managed", 
            "--region", "${_REGION}",
            "--image", "gcr.io/$PROJECT_ID/${_SERVICE_NAME}"]

# substitutions:
#   _REGION: (the region)
#   _SQL_INSTANCE_NAME: (just the name, PROJECT_ID:REGION:INSTANCE_NAME)
#   _SERVICE_NAME: (the cloud run service)
#
# Automatically provided:
#   PROJECT_ID: (the project)